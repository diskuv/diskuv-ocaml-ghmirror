# This is split into two jobs so that each completes within the one hour time limit of a shared cluster.

variables:
  OCAML_OPAM_REPO_DEPLOY_FOLDER_WINDOWS: 'OcamlOpamRepo'

windows:ocaml-opam-repo-fetch-1:
  extends:
    - .windows:before-script-shared-cygwin
  stage: prepare
  needs: []
  artifacts:
    untracked: false
    expire_in: 30 days
  rules:
    # - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "next"'
  cache:
    key:
      files:
        # this is a bit kludgy. We want cache key to be $DV_WindowsMsvcDockerImage
        # but this file contains the definition, so it is fine as the cache key.
        - installtime\windows\DeploymentVersion\DeploymentVersion.psm1
    paths:
      - "$OCAML_OPAM_REPO_DEPLOY_FOLDER_WINDOWS"
  script:
    - $DEPLOYDIR = "$env:OCAML_OPAM_REPO_DEPLOY_FOLDER_WINDOWS"
    - if (!(Test-Path "$DEPLOYDIR")) { New-Item -Path "$DEPLOYDIR" -ItemType Directory }
    - $REPODIR = "$DEPLOYDIR\share\diskuv-ocaml\ocaml-opam-repo"

    # Fetch
    - cygwin (
        'pwd && env TOPDIR=$PWD/installtime/none/emptytop installtime/unix/private/reproducible-fetch-ocaml-opam-repo-1-setup.sh'
        + " -d '" + "$PWD" + "'"
        + " -t '" + "$DEPLOYDIR" + "'"
        + " -v '" + $DV_WindowsMsvcDockerImage + "'"
        + " -a amd64"
        )
    - cygwin ("cd '" + "$DEPLOYDIR" + ''' && share/diskuv-ocaml/reproducible-builds/200-fetch-ocaml-opam-repo/installtime/unix/private/reproducible-fetch-ocaml-opam-repo-2-build-noargs.sh')
    - if (!(Test-Path -Path "$REPODIR\repo")) { throw "Build failed" }

windows:ocaml-opam-repo-trim-2:
  extends:
    - .windows:before-script-shared-cygwin
  stage: prepare
  needs: ["windows:ocaml-opam-repo-fetch-1"]
  artifacts:
    untracked: false
    expire_in: 30 days
  rules:
    # - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "next"'
  cache:
    policy: pull # do not modify the cache since we have a destructive operation on it that we may want to redo
    key:
      files:
        # this is a bit kludgy. We want cache key to be $DV_WindowsMsvcDockerImage
        # but this file contains the definition, so it is fine as the cache key.
        - installtime\windows\DeploymentVersion\DeploymentVersion.psm1
    paths:
      - "$OCAML_OPAM_REPO_DEPLOY_FOLDER_WINDOWS"
  script:
    - $DEPLOYDIR = "$env:OCAML_OPAM_REPO_DEPLOY_FOLDER_WINDOWS"
    - if (!(Test-Path "$DEPLOYDIR")) { New-Item -Path "$DEPLOYDIR" -ItemType Directory }
    - $REPODIR = "$DEPLOYDIR\share\diskuv-ocaml\ocaml-opam-repo"

    # Fetch again (but it should be cached!)
    - date
    - $ErrorActionPreference = "Continue"; cygwin (
        'pwd && env TOPDIR=$PWD/installtime/none/emptytop bash -x installtime/unix/private/reproducible-fetch-ocaml-opam-repo-1-setup.sh'
        + " -d '" + "$PWD" + "'"
        + " -t '" + "$DEPLOYDIR" + "'"
        + " -v '" + $DV_WindowsMsvcDockerImage + "'"
        + " -a amd64"
        )
    - cygwin ("cd '" + "$DEPLOYDIR" + ''' && share/diskuv-ocaml/reproducible-builds/200-fetch-ocaml-opam-repo/installtime/unix/private/reproducible-fetch-ocaml-opam-repo-2-build-noargs.sh')
    - if (!(Test-Path -Path "$REPODIR\repo")) { throw "Build failed" }

    # Trim
    - date
    - cygwin ("cd '" + "$DEPLOYDIR" + ''' && share/diskuv-ocaml/reproducible-builds/200-fetch-ocaml-opam-repo/installtime/unix/private/reproducible-fetch-ocaml-opam-repo-9-trim-noargs.sh')
    - if (!(Test-Path -Path "$REPODIR\pins")) { throw "Trim failed" }

    # Create .tar.gz and .zip
    - New-Item -Path "$EXTRASRC\oorepodist" -ItemType Directory
    - cygwin ('/usr/bin/tar cvCfz ''' + "$REPODIR" + ''' _ci/oorepodist/dist.tar.gz .')
    - Compress-Archive -Path "$REPODIR\*" -DestinationPath "$EXTRASRC\oorepodist\dist.zip"

    # Create public packages
    - if ("${env:CI_COMMIT_TAG}" -ne "") { $PACKAGE_REGISTRY_URL = "$PACKAGE_REGISTRY_GENERIC_URL/ocaml_opam_repo-reproducible/${env:CI_COMMIT_TAG}"; }
    - if ("${env:CI_COMMIT_TAG}" -ne "") { echo $PACKAGE_REGISTRY_URL; }
    - if ("${env:CI_COMMIT_TAG}" -ne "") { cygwin "curl --fail --header '$GLAB_CURL_HEADER' --upload-file _ci/oorepodist/dist.tar.gz '$PACKAGE_REGISTRY_URL'/ocaml-opam-repo.tar.gz"; }
    - if ("${env:CI_COMMIT_TAG}" -ne "") { cygwin "curl --fail --header '$GLAB_CURL_HEADER' --upload-file _ci/oorepodist/dist.zip    '$PACKAGE_REGISTRY_URL'/ocaml-opam-repo.zip"; }
